From b81853db75eb79eed747766bf6fb62f387854249 Mon Sep 17 00:00:00 2001
From: Rob Clark <robdclark@chromium.org>
Date: Thu, 18 Jul 2024 13:42:38 -0700
Subject: [PATCH 12/17] tu/drm/virtio: Add missing a7xx case

Signed-off-by: Rob Clark <robdclark@chromium.org>
---
 src/freedreno/vulkan/tu_knl_drm_virtio.cc | 12 ++++++++++--
 1 file changed, 10 insertions(+), 2 deletions(-)

diff --git a/src/freedreno/vulkan/tu_knl_drm_virtio.cc b/src/freedreno/vulkan/tu_knl_drm_virtio.cc
index c0d066faa58..af2a2b489f7 100644
--- a/src/freedreno/vulkan/tu_knl_drm_virtio.cc
+++ b/src/freedreno/vulkan/tu_knl_drm_virtio.cc
@@ -1009,8 +1009,16 @@ setup_fence_cmds(struct tu_device *dev)
 
       memset(c, 0, sizeof(*c));
 
-      c->pkt[0] = pm4_pkt7_hdr((uint8_t)CP_EVENT_WRITE, 4);
-      c->pkt[1] = CP_EVENT_WRITE_0_EVENT(CACHE_FLUSH_TS);
+      if (fd_dev_gen(&dev->physical_device->dev_id) >= A7XX) {
+         c->pkt[0] = pm4_pkt7_hdr((uint8_t)CP_EVENT_WRITE7, 4);
+         c->pkt[1] = CP_EVENT_WRITE7_0(.event = CACHE_FLUSH_TS,
+                           .write_src = EV_WRITE_USER_32B,
+                           .write_dst = EV_DST_RAM,
+                           .write_enabled = true).value;
+      } else {
+         c->pkt[0] = pm4_pkt7_hdr((uint8_t)CP_EVENT_WRITE, 4);
+         c->pkt[1] = CP_EVENT_WRITE_0_EVENT(CACHE_FLUSH_TS);
+      }
       c->pkt[2] = fence_iova;
       c->pkt[3] = fence_iova >> 32;
    }
-- 
2.45.2

